"use strict";function getQueryStringByName(n){var t=location.search.match(new RegExp("[?&]"+n+"=([^&]+)","i"));return t==null||t.length<1?"":t[1]}var CARD_TYPE=getQueryStringByName("card_type"),getValueInfo=function(n){var u=0,i=[],r,f,e;for(var t in n)r=Number(n[t].price),i[r]||(i[r]=0),f=n[t].price*n[t].ready,i[r]+=f,u+=f;u/=1e4;for(t in i)i[t]/=1e4;e="  总面值("+u+"万) ";for(t in i)e+=t+"("+i[t]+"万) ";return e},Showfullbg=function(){$("#reload_fullbg").show();$("#reload_icon").show()},Hidefullbg=function(){$("#reload_fullbg").hide();$("#reload_icon").hide()},MainContent=React.createClass({displayName:"MainContent",getPoolListConfig:function(){$.ajax({url:_.str.sprintf("/admin/card_pool_list?card_type=%s&requ_type=%s",encodeURIComponent(CARD_TYPE),encodeURIComponent("get_pool_list_config")),type:"get",dataType:"json",success:function(n){n.status=="ok"?this.setState({pool_list_config:n.data}):alert("卡池列表配置加载错误 "+n.msg)}.bind(this),error:function(n,t,i){alert("卡池列表配置加载异常 "+i.toString());console.error(this.props.url,t,i.toString())}.bind(this)})},getPoolList:function(){$.ajax({url:_.str.sprintf("/admin/card_pool_list?card_type=%s&requ_type=%s",encodeURIComponent(CARD_TYPE),encodeURIComponent("get_pool_list")),type:"get",dataType:"json",success:function(n){n.status=="ok"?this.setState({pool_list:n.data.pool_list}):alert("卡池列表加载错误 "+n.msg)}.bind(this),error:function(n,t,i){alert("卡池列表加载异常 "+i.toString());console.error(this.props.url,t,i.toString())}.bind(this)})},removeSourceBoxList:function(n){this.refs.PendingBoxList.addBoxList(n)},removePendingBoxList:function(n){this.refs.SourceCardPool.addBoxList(n)},onSourceCardPoolChange:function(n){this.refs.PendingBoxList.onSourceCardPoolChange(n)},selectSourceCardPool:function(n){this.refs.SourceCardPool.selectSourceCardPool(n)},getInitialState:function(){return{pool_list_config:{},pool_list:[]}},componentDidMount:function(){this.getPoolList();this.getPoolListConfig()},componentDidUpdate:function(){},render:function(){return React.createElement("div",{className:"wrapper"},React.createElement("div",{id:"reload_fullbg"}),React.createElement("div",{id:"reload_icon"},React.createElement("i",{className:"icon-spinner icon-spin icon-4x"})),React.createElement("div",{className:"col-md-12"},React.createElement("div",{className:"panel"},React.createElement("div",{className:"panel-heading row"},React.createElement("span",{className:"pull-left"},React.createElement("i",{className:"icon-table"}),"卡分配")),React.createElement("div",{className:"panel-body"},React.createElement(SourceCardPool,{ref:"SourceCardPool",pool_list:this.state.pool_list,onReMoveBoxList:this.removeSourceBoxList,onChangePool:this.onSourceCardPoolChange}),React.createElement(PendingBoxList,{ref:"PendingBoxList",pool_list:this.state.pool_list,onReMoveBoxList:this.removePendingBoxList,selectSourceCardPool:this.selectSourceCardPool})))))}}),SourceCardPool=React.createClass({displayName:"SourceCardPool",selectSourceCardPool:function(){this.onChangePool()},getBoxList:function(n){Showfullbg();$.ajax({url:_.str.sprintf("/admin/card_pool_list?card_type=%s&requ_type=%s&pool_name=%s",encodeURIComponent(CARD_TYPE),encodeURIComponent("get_box_list"),encodeURIComponent(n)),type:"get",dataType:"json",success:function(n){n.status=="ok"?(this.setState({box_list:n.data.box_list,value_info:getValueInfo(n.data.box_list)}),Hidefullbg()):(Hidefullbg(),alert("读取盒号列表出错 "+n.msg))}.bind(this),error:function(n,t,i){Hidefullbg();alert("读取盒号列表异常 "+i.toString());console.error(this.props.url,t,i.toString())}.bind(this)})},onChangePool:function(){var n=$("#selecte_source_pool").find("option:selected").val();this.getBoxList(n);this.props.onChangePool(n);this.refs.PoolHistory.getPoolHistory(n)},onRemoveBox:function(n){var t=this.state.box_list,i=[],u=null;for(var r in t)t[r].box_id==n?u=t[r]:i.push(t[r]);this.props.onReMoveBoxList([u]);this.setState({box_list:i,value_info:getValueInfo(i)})},removeALLBoxList:function(){this.props.onReMoveBoxList(this.state.box_list);this.setState({box_list:[],value_info:getValueInfo([])})},addBoxList:function(n){var t=this.state.box_list.concat(n);this.setState({box_list:t,value_info:getValueInfo(t)})},calcPageInfo:function(n){(typeof n=="undefined"||n<=0)&&(n=1);var i=this.state.box_list.length,t=Number(Math.ceil(i/this.state.page_size));n>t&&(n=t);this.setState({page_info:{page_index:n,max_page:t}})},getInitialState:function(){return{box_list:[],value_info:"",page_info:{},page_size:20}},componentDidMount:function(){},componentDidUpdate:function(n,t){this.props.pool_list!=n.pool_list&&this.onChangePool();this.state.box_list!=t.box_list&&this.calcPageInfo(this.state.page_info.page_index)},render:function(){var n=null;this.state.box_list.length>0&&(n=React.createElement("a",{className:"btn btn-info",onClick:this.removeALLBoxList},"全选 ",React.createElement("i",{className:"icon-arrow-right"})));var i=this.props.pool_list.map(function(n){return React.createElement("option",{value:n.pool_name},n.pool_name)}.bind(this)),t=this.state.page_size*(this.state.page_info.page_index-1),r=t+this.state.page_size,u=this.state.box_list.map(function(n,i){return i<t||i>=r?null:React.createElement("tr",null,React.createElement("td",null,n.filename),React.createElement("td",null,n["package"]),React.createElement("td",null,n.box_id),React.createElement("td",null,n.price),React.createElement("td",null,n.create_time),React.createElement("td",null,n.count),React.createElement("td",null,n.ready),React.createElement("td",null,n.inuse),React.createElement("td",null,n.used),React.createElement("td",null,n.error),React.createElement("td",null,React.createElement("a",{href:"javascript:void(0);",className:"icon-arrow-right",onClick:this.onRemoveBox.bind(this,n.box_id)})))}.bind(this));return React.createElement("div",{className:"col-md-6"},React.createElement("div",{className:"col-md-12"},React.createElement("div",{className:"panel"},React.createElement("div",{className:"panel-heading row"},React.createElement("span",{className:"pull-left"},React.createElement("i",{className:"icon-table"}),"源卡池",this.state.value_info),React.createElement("select",{className:"form-control",id:"selecte_source_pool",onChange:this.onChangePool},i)),React.createElement(PoolHistory,{ref:"PoolHistory"}),React.createElement("div",{className:"panel-body"},React.createElement("span",{className:"pull-right"},n),React.createElement("table",{className:"table table-responsive table-striped table-hover"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"文件名"),React.createElement("th",null,"箱号"),React.createElement("th",null,"盒号"),React.createElement("th",null,"面值"),React.createElement("th",null,"日期"),React.createElement("th",null,"总数"),React.createElement("th",null,"可用"),React.createElement("th",null,"在用"),React.createElement("th",null,"已用"),React.createElement("th",null,"错卡"),React.createElement("th",null,"操作"))),React.createElement("tbody",null,u)),React.createElement(PageIndexGroup,{updatePage:this.calcPageInfo,page_info:this.state.page_info})))))}}),PoolHistory=React.createClass({displayName:"PoolHistory",getPoolHistory:function(n){(Showfullbg(),n)&&$.ajax({url:_.str.sprintf("/admin/card_pool_list?card_type=%s&requ_type=%s&pool_name=%s",encodeURIComponent(CARD_TYPE),encodeURIComponent("get_pool_history"),encodeURIComponent(n)),type:"get",dataType:"json",success:function(n){n.status=="ok"?(this.setState({history_list:n.data.history_list}),Hidefullbg()):(Hidefullbg(),alert("读取卡池历史出错 "+n.msg))}.bind(this),error:function(n,t,i){Hidefullbg();alert("读取卡池历史异常 "+i.toString());console.error(this.props.url,t,i.toString())}.bind(this)})},getInitialState:function(){return{history_list:[]}},componentDidMount:function(){},render:function(){var n=this.state.history_list.map(function(n){var t=n+"\n";return{h:t}}.bind(this));return React.createElement("pre",{className:"col-md-12"},n)}}),PendingBoxList=React.createClass({displayName:"PendingBoxList",onSourceCardPoolChange:function(n){this.setState({source_pool:n});this.clearData()},resetBoxList:function(){this.props.onReMoveBoxList(this.state.box_list);this.clearData()},clearData:function(){this.setState({box_list:[],value_info:getValueInfo([])})},onRemoveBox:function(n){var t=this.state.box_list,i=[],u=null;for(var r in t)t[r].box_id==n?u=t[r]:i.push(t[r]);this.props.onReMoveBoxList([u]);this.setState({box_list:i,value_info:getValueInfo(i)})},addBoxList:function(n){var t=this.state.box_list.concat(n);this.setState({box_list:t,value_info:getValueInfo(t)})},onDistribution:function(){this.refs.ChooseDestPoolDlg.showDlg()},calcPageInfo:function(n){(typeof n=="undefined"||n<=0)&&(n=1);var i=this.state.box_list.length,t=Number(Math.ceil(i/this.state.page_size));n>t&&(n=t);this.setState({page_info:{page_index:n,max_page:t}})},getInitialState:function(){return{source_pool:null,box_list:[],value_info:"",page_info:{},page_size:20}},componentDidMount:function(){},componentDidUpdate:function(n,t){this.state.box_list!=t.box_list&&this.calcPageInfo(this.state.page_info.page_index)},render:function(){var n=this.state.page_size*(this.state.page_info.page_index-1),r=n+this.state.page_size,u=this.state.box_list.map(function(t,i){return(console.info(t),i<n||i>=r)?null:React.createElement("tr",null,React.createElement("td",null,t.filename),React.createElement("td",null,t["package"]),React.createElement("td",null,t.box_id),React.createElement("td",null,t.price),React.createElement("td",null,t.create_time),React.createElement("td",null,t.count),React.createElement("td",null,t.ready),React.createElement("td",null,t.inuse),React.createElement("td",null,t.used),React.createElement("td",null,t.error),React.createElement("td",null,React.createElement("a",{href:"javascript:void(0);",className:"icon-remove",onClick:this.onRemoveBox.bind(this,t.box_id)})))}.bind(this)),t=null,i=null;return this.state.box_list.length>0&&(t=React.createElement("a",{className:"btn btn-success",onClick:this.resetBoxList},"重置"),i=React.createElement("a",{className:"btn btn-danger",onClick:this.onDistribution},"分配")),React.createElement("div",{className:"col-md-6"},React.createElement("div",{className:"col-md-12"},React.createElement("div",{className:"panel"},React.createElement("div",{className:"panel-heading row"},React.createElement("span",{className:"pull-left"},React.createElement("i",{className:"icon-table"}),"待分配列表",this.state.value_info),React.createElement("span",{className:"pull-right"},t,i)),React.createElement("div",{className:"panel-body table-responsive"},React.createElement("table",{className:"table table-striped table-hover"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"文件名"),React.createElement("th",null,"箱号"),React.createElement("th",null,"盒号"),React.createElement("th",null,"面值"),React.createElement("th",null,"日期"),React.createElement("th",null,"总数"),React.createElement("th",null,"可用"),React.createElement("th",null,"在用"),React.createElement("th",null,"已用"),React.createElement("th",null,"错卡"),React.createElement("th",null,"操作"))),React.createElement("tbody",null,u)),React.createElement(PageIndexGroup,{updatePage:this.calcPageInfo,page_info:this.state.page_info})))),React.createElement(ChooseDestPoolDlg,{ref:"ChooseDestPoolDlg",pool_list:this.props.pool_list,source_pool:this.state.source_pool,box_list:this.state.box_list,selectSourceCardPool:this.props.selectSourceCardPool}))}}),ChooseDestPoolDlg=React.createClass({displayName:"ChooseDestPoolDlg",onOk:function(){var t=[],i,n,r;for(i in this.props.box_list)t.push(this.props.box_list[i].box_id);if(n=$("#select_dest_pool").find("option:selected").val(),!n){alert("目的池不能为空");return}r={requ_type:"move_box_list",argu_list:{source_pool:this.props.source_pool,dest_pool:n,move_box_list:t}};$("#ChooseDestPoolDlg_OK").attr({disabled:"disabled"});$("#ChooseDestPoolDlg_CANCLE").attr({disabled:"disabled"});Showfullbg();$.ajax({url:_.str.sprintf("/admin/card_pool_list?card_type=%s",encodeURIComponent(CARD_TYPE)),type:"post",dataType:"json",data:JSON.stringify(r),success:function(t){t.status=="ok"?(this.props.selectSourceCardPool(n),alert("操作成功"),this.hideDlg()):alert("分配卡盒出错 "+t.msg)}.bind(this),error:function(n,t,i){alert("分配卡盒异常 "+i.toString());console.error(this.props.url,t,i.toString())}.bind(this),complete:function(){$("#ChooseDestPoolDlg_OK").removeAttr("disabled");$("#ChooseDestPoolDlg_CANCLE").removeAttr("disabled")}.bind(this)})},showDlg:function(){$("#chooseDestPoolDlg").modal({backdrop:"static",keyboard:!1})},hideDlg:function(){Hidefullbg();$("#chooseDestPoolDlg").modal("hide")},getInitialState:function(){return{}},componentDidMount:function(){},componentDidUpdate:function(){},render:function(){var n=this.props.pool_list.map(function(n){return n.pool_name!=this.props.source_pool?React.createElement("option",{value:n.pool_name},n.pool_name):null}.bind(this));return React.createElement("div",{className:"modal",id:"chooseDestPoolDlg",tabIndex:"-1",role:"dialog"},React.createElement("div",{className:"modal-dialog"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},"选择目的卡池")),React.createElement("div",{className:"modal-body form-horizontal"},React.createElement("div",{className:"form-group add-pro-body"},React.createElement("div",{className:"col-md-12"},React.createElement("select",{className:"form-control",id:"select_dest_pool"},n)))),React.createElement("div",{className:"modal-footer form-horifooter"},React.createElement("button",{type:"button",className:"btn btn-danger",id:"ChooseDestPoolDlg_OK",onClick:this.onOk},"选择"),React.createElement("button",{type:"button",className:"btn btn-default",id:"ChooseDestPoolDlg_CANCLE","data-dismiss":"modal"},"取消")))))}}),PageIndexGroup=React.createClass({displayName:"PageIndexGroup",onClickPage:function(n){this.props.updatePage(n)},getInitialState:function(){return{}},componentDidMount:function(){},componentDidUpdate:function(){},render:function(){var i,r,u;if(this.props.page_info==null)return null;var n=this.props.page_info.page_index,t=this.props.page_info.max_page,s=n-4>0?n-4:1,h=n+4>t?t:n+4,f=[];for(i=s;i<=h;++i)f.push(i);var c=f.map(function(n){var t=null;return n==this.props.page_info.page_index&&(t="disabled"),React.createElement("button",{className:"btn btn-default",disabled:t,type:"button",onClick:this.onClickPage.bind(this,n)},n)}.bind(this)),e=null,o=null;return n<=1&&(e="disabled",o="disabled"),r=null,u=null,n>=t&&(r="disabled",u="disabled"),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-sm-12"},React.createElement("div",{className:"btn-row dataTables_filter"},React.createElement("div",{id:"page_group",className:"btn-group"},React.createElement("button",{className:"btn btn-default",type:"button",disabled:e,onClick:this.onClickPage.bind(this,1)},React.createElement("i",{className:"icon-fast-backward"})),React.createElement("button",{className:"btn btn-default",type:"button",disabled:o,onClick:this.onClickPage.bind(this,n-1)},React.createElement("i",{className:"icon-backward"})),c,React.createElement("button",{className:"btn btn-default",type:"button",disabled:r,onClick:this.onClickPage.bind(this,n+1)},React.createElement("i",{className:"icon-forward"})),React.createElement("button",{className:"btn btn-default",type:"button",disabled:u,onClick:this.onClickPage.bind(this,t)},React.createElement("i",{className:"icon-fast-forward"}))))))}});React.render(React.createElement(MainContent,null),document.getElementById("main-content"));